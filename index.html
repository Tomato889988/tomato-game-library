<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 核心修复：禁止页面缩放 + 锁定视口，防止滑动跑偏 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>番茄制作2048 游戏 - 完整版</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
        }

        body {
            background-color: #faf8ef;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 10px;
            /* 核心修复：禁止页面滚动 */
            overflow: hidden;
            touch-action: none; /* 禁用浏览器默认触摸行为 */
        }

        .container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 40px;
            font-weight: bold;
            color: #776e65;
        }

        .score-panel {
            display: flex;
            gap: 8px;
        }

        .score-container, .best-score-container {
            background-color: #bbada0;
            padding: 8px 12px;
            border-radius: 5px;
            color: white;
            text-align: center;
            min-width: 75px;
        }

        .score-label {
            font-size: 12px;
            color: #eee4da;
        }

        .score, .best-score {
            font-size: 20px;
            font-weight: bold;
        }

        .btn-group {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .control-btn {
            background-color: #8f7a66;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .difficulty-selector {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .difficulty-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background-color: #bbada0;
            color: white;
            font-weight: bold;
        }

        .difficulty-btn.active {
            background-color: #8f7a66;
        }

        .tips {
            color: #776e65;
            font-size: 13px;
            text-align: center;
        }

        .grid-container {
            width: 400px;
            height: 400px;
            background-color: #bbada0;
            border-radius: 10px;
            padding: 10px;
            position: relative;
            /* 核心修复：防止滑动穿透 */
            touch-action: manipulation;
        }

        .grid-row {
            display: flex;
            margin-bottom: 10px;
        }

        .grid-row:last-child {
            margin-bottom: 0;
        }

        .grid-cell {
            width: 87.5px;
            height: 87.5px;
            background-color: #cdc1b4;
            border-radius: 5px;
            margin-right: 10px;
        }

        .grid-cell:last-child {
            margin-right: 0;
        }

        .tile {
            position: absolute;
            width: 87.5px;
            height: 87.5px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
            transition: all 0.15s ease;
            animation: tilePop 0.2s ease;
        }

        @keyframes tilePop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .tile-2 { background-color: #eee4da; color: #776e65; }
        .tile-4 { background-color: #ede0c8; color: #776e65; }
        .tile-8 { background-color: #f2b179; color: #f9f6f2; }
        .tile-16 { background-color: #f59563; color: #f9f6f2; }
        .tile-32 { background-color: #f67c5f; color: #f9f6f2; }
        .tile-64 { background-color: #f65e3b; color: #f9f6f2; }
        .tile-128 { background-color: #edcf72; color: #f9f6f2; }
        .tile-256 { background-color: #edcc61; color: #f9f6f2; }
        .tile-512 { background-color: #edc850; color: #f9f6f2; }
        .tile-1024 { background-color: #edc53f; color: #f9f6f2; font-size: 28px; }
        .tile-2048 { background-color: #edc22e; color: #f9f6f2; font-size: 28px; }
        .tile-super { background-color: #3c3a32; color: #f9f6f2; font-size: 24px; }

        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(238, 228, 218, 0.85);
            display: flex; align-items: center; justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        .modal-btn {
            background: #8f7a66;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">2048</div>
            <div class="score-panel">
                <div class="score-container">
                    <div class="score-label">当前分数</div>
                    <div class="score" id="score">0</div>
                </div>
                <div class="best-score-container">
                    <div class="score-label">最高分</div>
                    <div class="best-score" id="best-score">0</div>
                </div>
            </div>
        </div>

        <div class="btn-group">
            <button class="control-btn" id="new-game-btn">重新开始</button>
            <button class="control-btn" id="sound-toggle">音效：开启</button>
        </div>

        <div class="difficulty-selector">
            <button class="difficulty-btn active" data-level="easy">简单</button>
            <button class="difficulty-btn" data-level="normal">普通</button>
            <button class="difficulty-btn" data-level="hard">困难</button>
        </div>

        <div class="tips">方向键 / 滑动控制移动</div>

        <div class="grid-container" id="grid-container">
            <div class="grid-row"><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div></div>
            <div class="grid-row"><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div></div>
            <div class="grid-row"><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div></div>
            <div class="grid-row"><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div></div>
        </div>
    </div>

    <div class="modal" id="win-modal">
        <div class="modal-content">
            <div class="modal-title">恭喜！</div>
            <div class="modal-text">你合成了2048，游戏胜利！</div>
            <button class="modal-btn" id="continue-btn">继续挑战</button>
            <button class="modal-btn" id="restart-win-btn">重新开始</button>
        </div>
    </div>

    <div class="modal" id="game-over-modal">
        <div class="modal-content">
            <div class="modal-title">游戏结束</div>
            <div class="modal-text" id="game-over-text">最终得分：0</div>
            <button class="modal-btn" id="restart-over-btn">重新开始</button>
        </div>
    </div>

    <script>
        let grid = [];
        let score = 0;
        let bestScore = 0;
        let gameOver = false;
        let gameWon = false;
        let soundEnabled = true;
        let difficulty = 'easy';
        let tileSpawnProbability = {
            easy: {2:0.95,4:0.05},
            normal: {2:0.9,4:0.1},
            hard: {2:0.85,4:0.15}
        };

        // 修复音效：替换为更稳定的公共音效源
        const sounds = {
            move: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3'),
            merge: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-mechanical-bling-210.mp3'),
            win: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'),
            gameOver: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-failure-arcade-alert-notification-240.mp3'),
            newTile: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-coin-collect-1587.mp3')
        };

        // 修复音效播放：添加兼容处理
        function playSound(type) {
            if (!soundEnabled || !sounds[type]) return;
            try {
                // 克隆音频对象避免播放冲突
                const soundClone = sounds[type].cloneNode();
                soundClone.volume = 0.5; // 降低音量避免刺耳
                soundClone.play();
            } catch (e) {
                console.log("音效播放提示：", e.message);
            }
        }

        const scoreElement = document.getElementById('score');
        const bestScoreElement = document.getElementById('best-score');
        const gridContainer = document.getElementById('grid-container');

        function init(){
            grid = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
            score = 0;
            gameOver = false;
            gameWon = false;
            updateScore();
            loadBestScore();
            addRandomTile();
            addRandomTile();
            render();
            closeModals();
        }

        function loadBestScore(){
            bestScore = +localStorage.getItem('2048-best')||0;
            bestScoreElement.textContent = bestScore;
        }

        function saveBestScore(){
            if(score>bestScore){
                bestScore=score;
                localStorage.setItem('2048-best',bestScore);
                bestScoreElement.textContent=bestScore;
            }
        }

        function addRandomTile(){
            let empty=[];
            for(let i=0;i<4;i++)for(let j=0;j<4;j++)if(grid[i][j]==0)empty.push([i,j]);
            if(empty.length==0)return;
            let [i,j] = empty[Math.random()*empty.length|0];
            grid[i][j] = Math.random() < tileSpawnProbability[difficulty][2] ? 2 : 4;
            playSound('newTile'); // 修复：添加新方块音效
        }

        function render(){
            gridContainer.querySelectorAll('.tile').forEach(t=>t.remove());
            for(let i=0;i<4;i++){
                for(let j=0;j<4;j++){
                    let v=grid[i][j];
                    if(v===0)continue;
                    let t=document.createElement('div');
                    t.classList.add('tile',v>=4096?'tile-super':`tile-${v}`);
                    t.textContent=v;
                    t.style.top = i*97.5 +10+'px';
                    t.style.left= j*97.5 +10+'px';
                    gridContainer.appendChild(t);
                    if(v===2048&&!gameWon){gameWon=true;showWin();}
                }
            }
        }

        function updateScore(){
            scoreElement.textContent=score;
            saveBestScore();
        }

        function vibrate(){
            if(navigator.vibrate && soundEnabled){
                navigator.vibrate(30);
            }
        }

        function move(dir){
            if(gameOver||gameWon)return;
            let g=JSON.parse(JSON.stringify(grid));
            let moved=0,merged=0;

            function slide(arr){
                let a=arr.filter(x=>x);
                for(let i=0;i<a.length-1;i++){
                    if(a[i]==a[i+1]){
                        a[i]*=2; score+=a[i]; a[i+1]=0; merged++;
                    }
                }
                a=a.filter(x=>x);
                while(a.length<4)a.push(0);
                return a;
            }

            if(dir=='left'){
                for(let i=0;i<4;i++){
                    let r=slide(g[i]);
                    if(r+''!==g[i]+'')moved=1;
                    g[i]=r;
                }
            }
            if(dir=='right'){
                for(let i=0;i<4;i++){
                    let r=slide([...g[i]].reverse()).reverse();
                    if(r+''!==g[i]+'')moved=1;
                    g[i]=r;
                }
            }
            if(dir=='up'){
                for(let j=0;j<4;j++){
                    let c=slide([g[0][j],g[1][j],g[2][j],g[3][j]]);
                    for(let i=0;i<4;i++){if(g[i][j]!==c[i])moved=1;g[i][j]=c[i];}
                }
            }
            if(dir=='down'){
                for(let j=0;j<4;j++){
                    let c=slide([g[0][j],g[1][j],g[2][j],g[3][j]].reverse()).reverse();
                    for(let i=0;i<4;i++){if(g[i][j]!==c[i])moved=1;g[i][j]=c[i];}
                }
            }

            if(moved){
                grid=g;
                addRandomTile();
                updateScore();
                render();
                vibrate();
                playSound(merged?'merge':'move'); // 修复：播放移动/合并音效
                checkGameOver();
            }
        }

        function checkGameOver(){
            for(let i=0;i<4;i++)for(let j=0;j<4;j++){
                if(grid[i][j]==0)return;
                if(i<3&&grid[i][j]==grid[i+1][j])return;
                if(j<3&&grid[i][j]==grid[i][j+1])return;
            }
            gameOver=true;
            showGameOver();
        }

        function closeModals(){
            document.getElementById('win-modal').classList.remove('active');
            document.getElementById('game-over-modal').classList.remove('active');
        }
        function showWin(){
            playSound('win'); // 修复：播放胜利音效
            document.getElementById('win-modal').classList.add('active');
        }
        function showGameOver(){
            playSound('gameOver'); // 修复：播放结束音效
            document.getElementById('game-over-text').textContent='最终得分：'+score;
            document.getElementById('game-over-modal').classList.add('active');
        }

        document.getElementById('new-game-btn').onclick=init;
        document.getElementById('restart-over-btn').onclick=init;
        document.getElementById('restart-win-btn').onclick=init;
        document.getElementById('continue-btn').onclick=()=>{closeModals();gameWon=false;};

        document.getElementById('sound-toggle').onclick=()=>{
            soundEnabled=!soundEnabled;
            document.getElementById('sound-toggle').textContent=soundEnabled?'音效：开启':'音效：关闭';
        };

        document.querySelectorAll('.difficulty-btn').forEach(b=>{
            b.onclick=()=>{
                document.querySelectorAll('.difficulty-btn').forEach(x=>x.classList.remove('active'));
                b.classList.add('active');
                difficulty=b.dataset.level;
                init();
            }
        });

        // 修复：阻止键盘事件默认行为（防止方向键滚动）
        document.addEventListener('keydown',e=>{
            if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){
                e.preventDefault();
            }
            if(gameOver)return;
            switch(e.key){
                case'ArrowLeft':move('left');break;
                case'ArrowRight':move('right');break;
                case'ArrowUp':move('up');break;
                case'ArrowDown':move('down');break;
                case'r':case'R':init();break;
            }
        });

        // 修复：触摸滑动时阻止屏幕滚动
        let sx=0,sy=0;
        document.addEventListener('touchstart',e=>{
            e.preventDefault(); // 阻止默认触摸行为
            sx=e.touches[0].clientX;
            sy=e.touches[0].clientY;
        });
        document.addEventListener('touchmove',e=>{
            e.preventDefault(); // 彻底禁止滑动时的屏幕滚动
        });
        document.addEventListener('touchend',e=>{
            e.preventDefault();
            let dx=e.changedTouches[0].clientX-sx;
            let dy=e.changedTouches[0].clientY-sy;
            if(Math.abs(dx)>Math.abs(dy)){
                if(dx>30)move('right');else if(dx<-30)move('left');
            }else{
                if(dy>30)move('down');else if(dy<-30)move('up');
            }
        });

        // 初始化游戏
        init();
    </script>
</body>
</html>
